<!DOCTYPE html>
<html>
<head>
    <title>Panel de Monitoreo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Panel de Monitoreo</h1>
    <form id="thresholdForm">
        Umbral de corriente: <input type="number" step="0.1" name="threshold" value="{{.Threshold}}">
        <button type="submit">Actualizar</button>
    </form>
    <div id="events">
        {{range .Events}}
            <div class="event">{{.}}</div>
        {{end}}
    </div>
    {{range $oficina, $hist := .History}}
        <h2>Oficina {{$oficina}}</h2>
        <p>Consumo actual: {{index $.CurrentA $oficina}} A</p>
        <p>Luces: {{if (index $.LightStatus $oficina)}}Encendidas{{else}}Apagadas{{end}}</p>
        <p>Aire acondicionado: {{if (index $.ACStatus $oficina)}}Encendido{{else}}Apagado{{end}}</p>
        <button onclick="turnOff('{{$oficina}}', 'ac')">Apagar Aire</button>
        <button onclick="turnOff('{{$oficina}}', 'all')">Apagar Todo</button>
        <canvas id="chart{{$oficina}}" width="400" height="100"></canvas>
        <script>
            var ctx = document.getElementById('chart{{$oficina}}').getContext('2d');
            var chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [1,2,3,4],
                    datasets: [{
                        label: 'Amperios',
                        data: {{printf "%#v" $hist}},
                        borderColor: 'blue',
                        fill: false
                    }]
                }
            });
        </script>
    {{end}}
    <script>
        document.getElementById('thresholdForm').onsubmit = function(e) {
            e.preventDefault();
            fetch('/set-threshold', {
                method: 'POST',
                body: JSON.stringify({threshold: parseFloat(this.threshold.value)}),
                headers: {'Content-Type': 'application/json'}
            }).then(() => location.reload());
        };
        function turnOff(sector, device) {
            fetch('/turn-off', {
                method: 'POST',
                body: JSON.stringify({sector: sector, device: device}),
                headers: {'Content-Type': 'application/json'}
            }).then(() => alert('Comando enviado para apagar ' + device + ' en oficina ' + sector));
        }
    </script>
</body>
</html>